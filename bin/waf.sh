#!/bin/bash

WAF_LOCK_FILE=/tmp/waf.lock

if [ -f $WAF_LOCK_FILE ]; then
    echo "Lock file exists. Exiting."
    exit 0
fi;

touch $WAF_LOCK_FILE

WAF_NGINX_BIN=${WAF_NGINX_BIN:-/usr/sbin/nginx}
WAF_PARSE_LOG_DIR=${WAF_PARSE_LOG_DIR:-/var/log/nginx}
WAF_ROOT_DIR=${WAF_ROOT_DIR:-/etc/nginx/waf}

WAF_BIN_DIR=$WAF_ROOT_DIR/bin
WAF_CONF_DIR=$WAF_ROOT_DIR/conf.d
WAF_RULES_DIR=$WAF_ROOT_DIR/rules
WAF_TEMPLATES_DIR=$WAF_ROOT_DIR/templates

if [ ! -f $WAF_ROOT_DIR/system-id ]; then

    for file in $WAF_TEMPLATES_DIR/*.txt; do
        filename=$(basename $file)
        if [ ! -f $WAF_RULES_DIR/$filename ]; then
            cp $file $WAF_RULES_DIR/$filename
        fi
    done;

    for file in $WAF_TEMPLATES_DIR/*.conf; do
        filename=$(basename $file)
        if [ ! -f $WAF_CONF_DIR/$filename ]; then
            cp $file $WAF_CONF_DIR/$filename
        fi
    done;

    cat /proc/sys/kernel/random/uuid > $WAF_ROOT_DIR/system-id

fi;

FILE=$WAF_CONF_DIR/waf_match.conf
FILE_TMP=$FILE.tmp
FILE_TMP2=$FILE.tmp2

echo '' > $FILE_TMP2

for logfile in $WAF_PARSE_LOG_DIR/waf.log $WAF_PARSE_LOG_DIR/waf.log.1; do
    if [ ! -f $logfile ]; then
        continue
    fi

    for ip in `cat $logfile | cut -d " " -f 1,7 | grep -if $WAF_RULES_DIR/rules.txt | cut -d " " -f1 | cut -d "." -f1,2,3 | sort | uniq`; do 
        echo "    "$ip".0/24 1;" >> $FILE_TMP2; 
    done;
done

echo "# Autogenerated file. Don't change manually!" > $FILE_TMP
echo "geo \$waf_match {" >> $FILE_TMP
echo "    default 0;" >> $FILE_TMP

echo "    #Start whitelist" >> $FILE_TMP

for ipaddr in `cat $WAF_RULES_DIR/whitelist.txt`; do
    echo "    "$ipaddr" 0;" >> $FILE_TMP
done;

echo "    #End whitelist" >> $FILE_TMP

echo "    #Start blacklist" >> $FILE_TMP

for ipaddr in `cat $WAF_RULES_DIR/blacklist.txt`; do
    echo "    "$ipaddr" 1;" >> $FILE_TMP
done;

echo "    #End blacklist" >> $FILE_TMP

cat $FILE_TMP2 | sort -n | uniq  >> $FILE_TMP
echo "}" >> $FILE_TMP

if [ -f $FILE ]; then
    DIFFRES=$(diff $FILE_TMP $FILE)
else
    DIFFRES="1"
fi;

if [ "$DIFFRES" != "" ]; then
    echo "diff"
    mv $FILE_TMP $FILE;
    rm $FILE_TMP2
    
    $WAF_NGINX_BIN -t

    if [ $? == 0 ]; then
        echo "reload nginx by waf"
        $WAF_NGINX_BIN -s reload
    fi;

else
    mv $FILE_TMP /tmp/.
    mv $FILE_TMP2 /tmp/.
fi;

if [ -f $WAF_LOCK_FILE ]; then
    rm $WAF_LOCK_FILE
fi;
